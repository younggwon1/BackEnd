# 1. Producer Acks, Batch, Page Cache, Flush

[[Kafka] 카프카 프로듀서 (Kafka Producer)](https://always-kimkim.tistory.com/entry/kafka101-producer)



### 1. Producer Acks

[Kafka 운영자가 말하는 Producer ACKS](https://www.popit.kr/kafka-%EC%9A%B4%EC%98%81%EC%9E%90%EA%B0%80-%EB%A7%90%ED%95%98%EB%8A%94-producer-acks/)

[Producer Configuration](https://4betterme.tistory.com/168)

[Kafka Producer 알아보기](https://sungjk.github.io/2021/01/23/kafka-producer.html)

[[Kafka] 아파치 카프카 알아보기(1) - 프로듀서/컨슈머](https://12bme.tistory.com/529)

[[Apache kafka 조금 아는 척하기] 카프카 프로듀서](https://freedeveloper.tistory.com/397)



> Producer가 사용하는 acks 옵션은 간단하게 말해 프로듀서가 메시지를 보내고 그 메시지를 카프카가 잘 받았는지 확인을 할 것인지 또는 확인을 하지 않을 것인지를 결정하는 옵션

#### Producer Acks의 종류

카프카 Document에서 [Producer Configs](https://kafka.apache.org/documentation/#producerconfigs)를 보면 acks옵션은 총 3가지로 구분되고 있으며, 옵션에 대해서 설명하면 아래와 같다.

| **OPTION**     | **Message LOSS** | **SPEED** | **DESCRIPTION**                                              |
| -------------- | ---------------- | --------- | ------------------------------------------------------------ |
| acks = 0       | 상               | 상        | 프로듀서는 자신이 보낸 메시지에 대해 카프카로부터 확인을 기다리지 않는다. |
| acks = 1       | 중               | 중        | 프로듀서는 자신이 보낸 메시지에 대해 카프카의 leader가 메시지를 받았는지 기다린다. follower들은 확인하지 않는다. leader가 확인응답을 보내고, follower에게 복제가 되기 전에 leader가 fail되면, 해당 메시지는 손실될 수 있다. |
| acks = all(-1) | 하               | 하        | 프로듀서는 자신이 보낸 메시지에 대해 카프카의 leader와 follower까지 받았는지 기다린다. 최소 하나의 복제본까지 처리된 것을 확인하므로 메시지가 손실될 확률은 거의 없다. |

=> acks 옵션에 따라 프로듀서가 메시지를 보내는 속도와 메시지 손실률이 다르다.

- **acks=0**

  - producer에서 acks=0 이라고 설정하면, producer는 메시지를 보내고 leader로부터 보낸 메시지에 대해 잘 받았는지 확인을 기다리지 않는다. producer는 응답을 기다리는 시간 없이 계속 보내기만 한다. 
  - 만약 producer가 메시지를 보내는 중간에 파티션의 leader가 다운되거나 서버가 다운되거나 할 경우에 메시지 일부가 손실될 수 있다. 이러한 이유 때문에 메시지 손실 가능성이 가장 높고, 보내는 속도 역시 가장 빠르다. 
  - 메시지의 손실을 감안하더라도 빠르게 메시지를 보내야 할 경우에 사용하면 좋다.

- **acks=1**

  - producer에서 acks=1 이라고 설정하면, producer는 메시지를 보내고 파티션의 leader로부터 메시지를 잘 받았는지 확인을 위해 기다린다. 

  - acks=0보다 메시지를 보내는 속도가 느리다. 하지만 파티션의 leader가 메시지를 받았는지 확인하기 때문에 메시지의 손실 가능성은 낮다. 

  - 그렇다고 해서 메시지가 손실될 가능성이 전혀 없는 것은 아니다.

    - 다음 예를 보며 확인

    1. 프로듀서가 acks=1로 메시지를 보낸다.

    2. 파티션의 leader가 메시지를 받고 프로듀서에게 acks에 대한 응답을 한다.

    3. follower가 leader의 업데이트된 메시지를 복제하려고 하는 시점에, leader가 down이 되어 메시지를 복제하지 못하였다.

    4. 파티션에서 leader의 존재가 사라졌기 때문에, follower는 파티션의 leader로 변하게 되며, 결국 조금 전 프로듀서가 보낸 메시지는 손실되게 된다.

- **acks=all(-1)**

  - producer에서 acks=all 이라고 설정하면, producer는 메시지를 보내고 leader뿐만 아니라 follower까지 복제가 완료 되었는지 확인을 한다. 
  - leader와 follower 모두가 메시지를 정상적으로 받았는지를 확인하기 때문에 메시지 손실률은 제로에 가깝다. 
  - 하지만 확인을 위해서 기다리는 시간이 길어지기 때문에 프로듀서가 메시지를 보내는 속도 부분에서는 가장 느리다. 
  - 메시지의 손실률이 매우 중요한 경우에 적합한 옵션이다.
  - **만약 파티션의 leader는 메시지를 잘 받았는데, follower가 복제를 하지 못했다면? 또는 복제하는 job이 실패했다면 어떻게 될까?**
    - **Replication Factor가 2**인 경우
      - 복제 작업이 실패하면서, leader는 producer에게 메시지를 잘 받았다는 확인 응답을 할 수 없게된다. 결국 producer가 보낸 메시지는 실패 처리가 된다.
    - **Replication Factor가 3** 이상인 경우
      - Replication Factor가 3이면, 1개의 leader와 2개의 follower가 존재
      - broker 2의 follower는 복제가 성공하고 broker 3의 follower는 복제를 실패했다. 이런 경우에 파티션의 leader가 프로듀서에게 성공적으로 메시지를 기록했다는 확인 응답을 보낼 수 있을까? 정답은 확인 응답을 보낼 수도 있고, 보내지 못할 수도 있다. 
      - 위와 같은 상황에 필요한 옵션이 바로 **min.insync.replicas**이다. 
        - **min.insync.replicas**
          - producer가 acks=all로 설정하여 메시지를 보낼 때, write를 성공하기 위한 최소 복제본의 수를 의미
          - 이 옵션은 producer의 옵션이 아니고, **broker의 옵션**
            - 브로커의 config/server.properties 파일에서 설정을 변경할 수 있으며, 기본값은 1이다. 





### 2. Producer Batch

- **batch.size**

  - producer는 같은 토픽-파티션으로 전송되는 메시지를 "배치(batch)"라는 단위로 모아서 전송한다. 
  - "batch.size"는 이 배치의 사이즈를 결정하는 프로퍼티로 메시지를 어느정도 모았다가 브로커로 전송할 것인지를 결정하는 설정 값이다. 기본적으로 프로듀서는 배치 사이즈만큼 데이터가 모이면 브로커로 한번에 전송한다. 

  - 물론 프로듀서가 무조건 배치가 가득 찰 때까지 기다리는 것은 아니다. "**linger.ms**"에 설정된 시간이 지나면 배치가 가득차지 않아도 브로커로 메시지를 전송한다. 따라서 batch.size 값을 너무 크게 잡으면 batch.size 만큼의 메시지가 모이기도 전에 전송하기 때문에 사용하지도 못하는 메모리를 할당받는 낭비를 발생시킬 수도 있다. 반대로 너무 작게 잡으면 너무 자주 배치 전송이 발생해서 비효율적인 동작을 보일 수도 있다.





### 3. Producer Page Cache





### 4. Producer Flush